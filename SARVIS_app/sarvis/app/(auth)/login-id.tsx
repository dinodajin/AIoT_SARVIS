import React, { useMemo, useState } from 'react';
import { StyleSheet, Text, TextInput, View, Alert, ActivityIndicator } from 'react-native';
import { useRouter } from 'expo-router';
import { SafeAreaView } from 'react-native-safe-area-context';

import { SarvisAppHeader } from '@/components/sarvis/sarvis-app-header';
import { SarvisButton } from '@/components/sarvis/sarvis-button';
import { SarvisLogo } from '@/components/sarvis/sarvis-logo';
import { SarvisTheme } from '@/constants/sarvis-theme';
import { useAuth } from '@/providers/auth-provider';
import { authAPI } from '@/api/auth';

// ì…ë ¥ ìœ íš¨ì„± ê²€ì‚¬ (ìµœì†Œ 1ì ì´ìƒë§Œ í™•ì¸)
const idRegex = /^.{1,}$/;
const passwordRegex = /^.{1,}$/;

export default function LoginIdScreen() {
    const router = useRouter();
    const { signIn } = useAuth();

    const [loginId, setLoginId] = useState('');
    const [password, setPassword] = useState('');
    const [loading, setLoading] = useState(false);

    const idValid = useMemo(() => idRegex.test(loginId), [loginId]);
    const pwValid = useMemo(() => passwordRegex.test(password), [password]);

    const canSubmit = idValid && pwValid && !loading;

    const handleLogin = async () => {
        if (!canSubmit) return;

        setLoading(true);
        try {
            // ì‹¤ì œ API í˜¸ì¶œ
            const response = await authAPI.login(loginId, password);
            console.log('ğŸ” ë¡œê·¸ì¸ ì‘ë‹µ:', JSON.stringify(response, null, 2));

            // ì„œë²„ ì‘ë‹µ í˜¸í™˜ì„± ì²˜ë¦¬ (tokens ë˜ëŠ” access_token í™•ì¸)
            const hasTokens = response.tokens || response.access_token;

            if (response.success && hasTokens) {
                // 1. ì„ì‹œ í† í° ì €ì¥ (profile ì¡°íšŒ ë“± í•„ìš”ì‹œ ì‚¬ìš©)
                let accessToken = '';
                if (response.tokens) {
                    accessToken = response.tokens.access;
                } else if (response.access_token && typeof response.access_token === 'object') {
                    accessToken = response.access_token.access;
                } else if (typeof response.access_token === 'string') {
                    accessToken = response.access_token;
                }

                if (accessToken) {
                    const { default: AsyncStorage } = await import('@react-native-async-storage/async-storage');
                    await AsyncStorage.setItem('@sarvis_access_token', accessToken);
                }

                // 2. í”„ë¦¬ì…‹ ëª©ë¡ ì§ì ‘ ì¡°íšŒ (ì„œë²„ ì‘ë‹µì— ì—†ì„ ìˆ˜ ìˆìŒ)
                let userPresets: any[] = [];
                let hasPresets = false;

                if (response.presets && response.presets.length > 0) {
                    userPresets = response.presets;
                    hasPresets = true;
                } else {
                    try {
                        console.log('ğŸ” í”„ë¦¬ì…‹ ëª©ë¡ ë³„ë„ ì¡°íšŒ ì‹œë„...');
                        const presetRes = await import('@/api/preset').then(m => m.presetAPI.getPresets());
                        if (presetRes && presetRes.presets && presetRes.presets.length > 0) {
                            userPresets = presetRes.presets;
                            hasPresets = true;
                            console.log(`âœ… í”„ë¦¬ì…‹ ì¡°íšŒ ì„±ê³µ: ${userPresets.length}ê°œ`);
                        }
                    } catch (e) {
                        console.warn('âš ï¸ í”„ë¦¬ì…‹ ì¡°íšŒ ì‹¤íŒ¨:', e);
                    }
                }

                // 3. í”„ë¡œí•„ ì •ë³´ ì¡°íšŒ (ë‹‰ë„¤ì„, ì´ë©”ì¼ ë“± í™•ì‹¤íˆ ê°€ì ¸ì˜¤ê¸°)
                let userData = { ...response };
                try {
                    console.log('ğŸ‘¤ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì¤‘...');
                    const profileRes = await authAPI.getProfile();
                    console.log('âœ… ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì„±ê³µ:', profileRes);

                    const userProfile = (profileRes as any).user;
                    if (userProfile) {
                        userData = {
                            ...userData,
                            nickname: userProfile.nickname,
                            email: userProfile.email,
                            user_id: userProfile.user_id,
                            uid: userProfile.uid,
                            login_id: userProfile.login_id
                        };
                    }
                } catch (e) {
                    console.warn('âš ï¸ í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨ (ë¡œê·¸ì¸ ì‹œ ì •ë³´ ì‚¬ìš©):', e);
                }

                await signIn({
                    ...userData,
                    nickname: userData.nickname || loginId, // í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨ ì‹œì—ë§Œ loginId ì‚¬ìš©
                    presets: userPresets, // ì¡°íšŒí•œ í”„ë¦¬ì…‹ ëª©ë¡ ì£¼ì…
                    has_presets: hasPresets
                });

                // 4. í™”ë©´ ì´ë™ (ë¬´ì¡°ê±´ í”„ë¦¬ì…‹ ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™í•˜ì—¬ ê¸°ë³¸ í”„ë¦¬ì…‹ì´ë¼ë„ ì„ íƒí•˜ê²Œ í•¨)
                console.log('ğŸ‘‰ í”„ë¦¬ì…‹ ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                router.replace('/(auth)/preset-selection');
            } else {
                console.log('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨:', response.message);
                Alert.alert('ë¡œê·¸ì¸ ì‹¤íŒ¨', response.message || 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        } catch (error: any) {
            console.error('ë¡œê·¸ì¸ ì—ëŸ¬:', error);

            let errorMessage = 'ë¡œê·¸ì¸ ì¤‘ ì˜ˆê¸°ì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';

            if (error.response) {
                // ì„œë²„ê°€ ì‘ë‹µì„ ë°˜í™˜í•œ ê²½ìš° (4xx, 5xx)
                const status = error.response.status;
                const data = error.response.data;

                if (status === 401 || status === 400) {
                    errorMessage = 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                } else if (status === 500) {
                    errorMessage = 'ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                } else if (data && data.message) {
                    errorMessage = data.message;
                }
            } else if (error.request) {
                // ìš”ì²­ì€ ë³´ëƒˆìœ¼ë‚˜ ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ì§€ ëª»í•œ ê²½ìš° (ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜, íƒ€ì„ì•„ì›ƒ)
                errorMessage = 'ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
            } else {
                // ê¸°íƒ€ ì—ëŸ¬
                errorMessage = error.message;
            }

            Alert.alert('ë¡œê·¸ì¸ ì‹¤íŒ¨', errorMessage);
        } finally {
            setLoading(false);
        }
    };

    return (
        <View style={styles.container}>
            <SarvisAppHeader
                title=""
                showBackButton={true}
                showMenuButton={false}
                showUserBadge={false}
            />

            <SafeAreaView style={styles.safeArea}>
                <View style={styles.content}>
                    <SarvisLogo subtitle="ë¡œê·¸ì¸" />

                    <View style={styles.form}>
                        {!loading ? (
                            <>
                                <View style={styles.formGroup}>
                                    <Text style={styles.label}>ì•„ì´ë””</Text>
                                    <TextInput
                                        value={loginId}
                                        onChangeText={setLoginId}
                                        autoCapitalize="none"
                                        style={styles.input}
                                        placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                        placeholderTextColor={SarvisTheme.colors.textMuted}
                                    />
                                </View>

                                <View style={styles.formGroup}>
                                    <Text style={styles.label}>ë¹„ë°€ë²ˆí˜¸</Text>
                                    <TextInput
                                        value={password}
                                        onChangeText={setPassword}
                                        secureTextEntry
                                        style={styles.input}
                                        placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                        placeholderTextColor={SarvisTheme.colors.textMuted}
                                    />
                                </View>

                                <SarvisButton
                                    title={loading ? 'ë¡œê·¸ì¸ ì¤‘...' : 'ë¡œê·¸ì¸'}
                                    variant="primary"
                                    disabled={!canSubmit}
                                    onPress={handleLogin}
                                />

                                <View style={styles.linksRow}>
                                    <Text
                                        style={styles.link}
                                        onPress={() => router.push({ pathname: '/(auth)/find-id' } as any)}
                                    >
                                        ì•„ì´ë”” ì°¾ê¸°
                                    </Text>
                                    <Text style={styles.linkDivider}>|</Text>
                                    <Text
                                        style={styles.link}
                                        onPress={() => router.push({ pathname: '/(auth)/find-password' } as any)}
                                    >
                                        ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°
                                    </Text>
                                </View>
                            </>
                        ) : (
                            <View style={styles.loadingContainer}>
                                <ActivityIndicator size="large" color={SarvisTheme.colors.primary} />
                                <Text style={styles.loadingText}>ë¡œê·¸ì¸ ì¤‘...</Text>
                            </View>
                        )}
                    </View>
                </View>
            </SafeAreaView>
        </View>
    );
}

const styles = StyleSheet.create({
    container: {
        flex: 1,
        backgroundColor: SarvisTheme.colors.bg,
    },
    safeArea: {
        flex: 1,
    },
    content: {
        paddingHorizontal: 20,
        paddingTop: 80,
        paddingBottom: 24,
    },
    form: {
        width: '100%',
    },
    formGroup: {
        marginBottom: 18,
    },
    label: {
        fontWeight: '800',
        fontSize: 14,
        marginBottom: 8,
        color: SarvisTheme.colors.text,
    },
    input: {
        width: '100%',
        paddingVertical: 14,
        paddingHorizontal: 16,
        borderRadius: SarvisTheme.radius.md,
        borderWidth: 0,
        backgroundColor: SarvisTheme.colors.primaryLight,
        fontSize: 15,
        color: SarvisTheme.colors.text,
    },
    hintError: {
        marginTop: 6,
        fontSize: 12,
        fontWeight: '600',
        color: SarvisTheme.colors.danger,
    },
    linksRow: {
        flexDirection: 'row',
        justifyContent: 'center',
        alignItems: 'center',
        marginTop: 16,
        marginBottom: 12,
        gap: 12,
    },
    link: {
        color: SarvisTheme.colors.primary,
        fontSize: 13,
        fontWeight: '700',
        textDecorationLine: 'underline',
    },
    linkDivider: {
        color: SarvisTheme.colors.textLight,
        fontWeight: '700',
    },
    loadingContainer: {
        alignItems: 'center',
        marginBottom: 16,
    },
    loadingText: {
        marginTop: 8,
        fontSize: 14,
        fontWeight: '600',
        color: SarvisTheme.colors.primary,
    },
});
