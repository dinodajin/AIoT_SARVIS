# SARVIS 유스케이스 정의서 (수정본)

**버전:** 2.0  
**작성일:** 2026-01-30  
**기준 문서:** 기능별_상세_명세.md v4.1, API_specification.md v1.0

---

## 목차

1. [일반 사항](#1-일반-사항)
2. [통신 구조](#2-통신-구조)
3. [로그인](#3-로그인)
4. [회원가입](#4-회원가입)
5. [메인 화면](#5-메인-화면)
6. [메뉴](#6-메뉴)
7. [에러 및 예외 처리](#7-에러-및-예외-처리)
8. [와이어프레임](#8-와이어프레임)

---

## 1. 일반 사항

- 세션 만료, 로그아웃, 회원 탈퇴 시 로그인 초기 화면으로 이동
- 음성/얼굴 재설정, 앱 재실행(세션 유지) 시 메인 화면(홈 탭)으로 이동
- 모든 화면 반응형 구현

---

## 2. 통신 구조

### 2.1 통신 방식 개요

SARVIS 시스템은 3가지 통신 방식을 사용합니다:

| 통신 방식 | 용도 | 사용 범위 | 주요 특징 |
|-----------|------|----------|----------|
| **WebSocket** | 실시간 기기 상태 모니터링 | 하트비트 전송만 | Jetson-서버 간 10초 간격 |
| **REST API** | 모든 앱-서버 통신 | 인증, 회원가입, 제어 등 모든 기능 | 상태 비저장, 요청-응답 기반 |
| **Jetson HTTP** | 로컬 벡터화 연산 | 얼굴/음성 원본 파일 전송 | 로컬 네트워크(192.168.x.x) 내 통신 |

### 2.2 통신 흐름도

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         앱 (Android)                            │
└──────────────┬────────────────────────────────────────────────────┘
               │
               │ REST API (HTTPS/WSS)
               │ - 인증, 회원가입, 기기 관리
               │ - 로봇 제어, 프리셋 관리
               │ - 사용자 관리, 생체 정보 관리
               ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                      서버 (EC2)                                 │
│                                                                │
│  - REST API: 모든 비즈니스 로직 처리                               │
│  - WebSocket: Jetson 하트비트 수신 (10초 간격)                       │
│  - Database: User, Device, Session 등 데이터 저장                     │
└──────────────┬────────────────────────────────────────────────────┘
               │
               │ WebSocket (WSS)
               │ - 하트비트 수신 (Jetson → 서버)
               │ - 하트비트 응답 (서버 → Jetson)
               ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                      Jetson                                      │
│                                                                │
│  - 로컬 벡터화 연산: 얼굴(512-dim), 음성(256-dim)                │
│  - RPi 통신: 로봇 제어 신호 전송                                  │
│  - 마이크: 음성 인식 및 명령 파싱                                    │
└──────────────┬────────────────────────────────────────────────────┘
               │
               │ Jetson HTTP (로컬)
               │ - 얼굴/음성 원본 파일 수신
               │ - 로컬 벡터화 연산 수행
               ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                      앱 (Android)                                │
│                                                                │
│  - Jetson으로 원본 파일 전송                                        │
│  - 벡터 데이터 수신                                              │
│  - 서버로 벡터 전송 (REST API)                                   │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 WebSocket 사용 범위 제한

**WebSocket은 오직 하트비트 기능에만 사용됩니다:**
- Jetson → 서버: 10초 간격 하트비트 전송
  ```json
  {
    "type": "heartbeat",
    "device_id": "JETSON-001",
    "timestamp": 1640739900,
    "wifi_signal": 85,
    "connection_status": "connected"
  }
  ```
- 서버 → Jetson: 하트비트 응답 (heartbeat_ack)
  ```json
  {
    "type": "heartbeat_ack",
    "device_id": "JETSON-001",
    "timestamp": 1640739900
  }
  ```
- 기기 연결/연결해제 감지만 처리

**WebSocket 사용하지 않는 기능 (REST API로 처리):**
- 로봇 제어 명령 → `POST /api/robot/command`
- 로봇 상태 업데이트 → `PUT /api/sessions/{session_id}/robot-status`
- 핸드프리 유튜브 제어 → `POST /api/robot/command` (action: youtube_control)
- 세션 관리 → `GET /api/sessions/current`, `POST /api/session/start`
- 기기 연결 관리 → `POST /api/devices/{device_id}/connect`

### 2.4 Jetson 로컬 HTTP 통신 구조

**Jetson 로컬 HTTP 엔드포인트:**
- URL: `http://192.168.x.x:8000`
- 프로토콜: HTTP (로컬 네트워크)
- 보안: 로컬 네트워크 내 통신만 허용 (192.168.x.x)

**통신 흐름:**
```
[앱] 얼굴 이미지 캡처
  ↓ POST http://192.168.x.x:8000/register/upload (FormData: face_image)
[Jetson] 얼굴 이미지 수신
  ↓ 로컬 임베딩 연산 (얼굴 벡터 추출, 512-dim)
  ↓ POST /api/register/face-vector (JSON: face_vector)
[서버] 벡터 데이터 수신
  ↓ Redis 캐시에 임시 저장
  ↓ 응답: { "success": true }
[앱] 다음 단계로 이동
```

---

## 3. 로그인

### 3.1 앱 초기 실행 화면

**앱 최초 실행 시 권한 요청:**
- 앱 최초 실행 시 접근성 서비스 권한 요청
- **[권한 안내 팝업]** 표시
  - 메시지: "유튜브 조작을 위해 접근성 권한이 필요합니다."
  - 설명: "SARVIS 앱이 유튜브와 같은 다른 앱을 제어하려면 시스템 설정에서 접근성 권한을 허용해야 합니다."
  - "설정하러 가기" 버튼 클릭 → 안드로이드 시스템 접근성 설정 화면으로 이동
- 사용자가 SARVIS 서비스를 '허용'으로 전환 후 앱으로 복귀

**초기 상태:**
- SARVIS 로고 및 "Smart Assistance Robot" 태그라인 표시
- 버튼 노출: "SARVIS 시작"(MAIN 버튼), "아이디로 로그인"/"회원가입" (하단에 연한 글씨로 작게, 기기 연결 감지 전 비활성화)
- 연결 상태 인디케이터 표시
- 상태 메시지: "기기 연결 대기중..."
- 30초간 기기 연결 감지 (BLE Advertise 스캔)
- 연결 완료 시: "기기가 감지되었습니다!" 메시지 표시
- 로그인, 회원가입 버튼 활성화

**연결 실패 시:**
- 30초 타임아웃 후 "기기 연결 실패\n기기가 연결되지 않았습니다. 케이블을 확인하고 다시 시도해주세요." 에러 메시지
- 연결 재시도 버튼 노출

**푸터 정보:**
- **Copyright:** © 2026 Team S.A.R.V.I.S. All rights reserved.
- **License:** (추후 설정 예정)
- **Links:** 이용약관 | 개인정보 처리방침 | [Gitlab](https://lab.ssafy.com/s14-webmobile3-sub1/S14P11A104)

---

### 3.2 얼굴 인식 로그인

**실행 흐름:**
1. 카메라 자동 활성화 (3초간 스캔)
2. 얼굴 스캔 진행 중 안내 메시지 표시: "얼굴을 중앙에 맞춰주세요", "조명을 밝게 해주세요"
3. 얼굴 이미지 캡처
4. **Jetson 로컬 통신:** 얼굴 이미지 Jetson 전송
   ```
   POST http://192.168.x.x:8000/auth/face-verify
   FormData: { user_id, face_image }
   ```
5. Jetson에서 로컬 임베딩 연산 (얼굴 벡터 추출, 512-dim)
6. **REST API:** 벡터 데이터 서버 전송
   ```
   POST /api/auth/face-verify
   Request: { "face_vector": [0.123, -0.456, ...] }
   Response: { "success": true, "data": { "user_id": 1, "token": "...", "user": {...}, "session_id": 1 } }
   ```
7. 얼굴 인식 성공 시 "사용자 인식 완료!" 메시지
8. 기존에 저장된 "기기 프리셋 목록" 노출
9. "새로 시작" 버튼 선택 혹은 프리셋 선택으로 로그인 완료
10. 자동으로 메인 화면(홈 탭)으로 이동

**얼굴 스캔 실패:**
- 첫 번째 실패(3초간 스캔 실패): "얼굴 스캔 재시도" 버튼 노출
- 첫 시도 포함 3회 실패 시: "회원 정보를 찾을 수 없습니다" 메시지 + "수동 로그인", "회원가입" 버튼 노출

**스캔 중 취소:**
- "스캔 중지" 버튼 클릭
- "스캔을 중단하시겠습니까?" 확인 팝업
- 확인 시 로그인 초기 화면으로 복귀

---

### 3.3 아이디/비밀번호 로그인

**실행 흐름:**
1. "아이디로 로그인" 버튼 선택
2. 아이디 입력
3. 비밀번호 입력
4. "로그인" 버튼 클릭
5. **REST API:** 로그인 요청
   ```
   POST /api/auth/login
   Request: { "login_id": "dae_lee", "password": "Secure123!" }
   Response: { "success": true, "data": { "user_id": 1, "token": "...", "refresh_token": "...", "user": {...}, "session_id": 1 } }
   ```
6. 로그인 성공 시 기기 연결 대기 화면 표시 (상단: "기기 연결 필수" 안내, 연결 상태 인디케이터)
7. 기기 연결 완료 후 기존에 저장된 "기기 프리셋 목록" 노출
8. 선택 후 메인 화면(홈 탭)으로 이동

**로그인 실패 (아이디/비밀번호 오류):**
- "아이디 또는 비밀번호가 올바르지 않습니다." 메시지
- 입력 필드 빨간색 테두리 표시

**필수 정보 미입력:**
- "아이디와 비밀번호를 입력해주세요." 메시지
- 미입력 필드에 포커스 이동

**회원가입 버튼을 통한 회원가입 페이지 연결:**
- 하단 회원가입 버튼을 통해 회원가입 페이지로 이동 가능

---

### 3.4 자동 로그인 (세션 유지)

**실행 흐름:**
1. 앱 재실행 시 로컬 스토리지에 저장된 JWT 존재 여부 확인
2. 기기 연결 확인
3. **REST API:** 세션 유효성 확인
   ```
   GET /api/sessions/current
   Headers: Authorization: Bearer {jwt_token}
   Response: { "success": true, "data": { "session_id": 1, "user_id": 1, "connection_status": "CONNECTED" } }
   ```
4. 세션 유효 시 자동 로그인 진행
5. 바로 메인 화면(홈 탭) 표시

**기기 연결 중:**
- Jetson에서 **WebSocket 하트비트 전송** (10초 간격)
  ```
  WebSocket: wss://i14a104.p.ssafy.io:8000/ws/heartbeat/
  Message: { "type": "heartbeat", "device_id": "JETSON-001", "timestamp": 1640739900, "wifi_signal": 85 }
  ```
- 서버에서 JWT 만료 시간 갱신
- 연결이 지속되는 한 세션을 실시간 갱신하여 무제한 유지

**기기 연결 끊김:**
- Jetson에서 WebSocket 연결 끊김 감지
- 서버에서 앱으로 알림 전송 (앱도 WebSocket 연결)
- "기기가 연결되지 않았습니다. 기기를 연결해주세요." 메시지
- 연결 해제 시점을 기준으로 60분의 유예 시간을 카운트다운
- 메인 화면 전체에 반투명 오버레이(Opacity 0.5) 적용 및 컴포넌트 터치 이벤트 비활성화
- 유선 연결 해제 시점으로부터 60분 동안만 유효한 임시 세션 부여
- 60분 이내에 재연결될 경우 '기기 연결 중'으로 복귀하며,
  미연결 상태로 60분 경과 시 세션을 즉시 만료시킨다

**세션 만료:**
- 만료 조건:
  1. 기기 미연결 상태에서 60분이 경과한 경우
  2. 서버로부터 401 Unauthorized 응답을 받은 경우
  3. JWT 토큰 만료 시간 (기본 24시간) 경과 후 연결이 끊긴 경우
- "세션이 만료되었습니다. 다시 로그인해주세요." 안내 메시지 표시
- 로컬에 저장된 모든 토큰 정보 삭제 및 로그인 초기 화면으로 강제 이동
- 로그인 초기 화면으로 이동

---

## 4. 회원가입

### 4.1 회원가입 시작

**실행 흐름:**
1. 로그인 초기 화면 혹은 자동 로그인 실패 화면, 아이디로 로그인 화면에서 "회원가입" 버튼 선택
2. 회원가입 초기 화면으로 이동

**가입 취소:**
- 어느 단계에서든 "가입 취소" 또는 "뒤로" 버튼 클릭
- "회원가입을 취소하면 모든 정보가 초기화됩니다. 정말 취소하시겠습니까?" 확인 팝업
- 확인 시 모든 절차 초기화 후 로그인 초기 화면으로 복귀

---

### 4.2 Step 1: 정보 입력

#### 4.2.1 닉네임 입력
- 닉네임 입력 필드 (한글, 영문, 숫자 2-20자)
- 실시간 형식 검증 (불가능한 문자 입력 시 경고)

#### 4.2.2 아이디 입력
- 아이디 입력 필드 (영문/숫자 5-20자)
- 실시간 형식 검증
- "중복확인" 버튼 클릭 → **REST API**
  ```
  POST /api/auth/check-id
  Request: { "login_id": "dae_lee" }
  Response: { "success": true, "available": true, "message": "사용 가능한 아이디입니다." }
  ```
  - 사용 가능: "사용 가능한 아이디입니다." (초록색) + 필드 비활성화
  - 중복: "이미 사용 중인 아이디입니다." (빨간색)
  - 형식 오류: "아이디 형식이 올바르지 않습니다." (빨간색)
- "아이디 변경" 버튼 (중복 확인 후 표시, 클릭 시 아이디 수정 가능)

#### 4.2.3 이메일 입력
- 이메일 아이디 입력 필드
- 도메인 선택 (드롭다운: naver.com, gmail.com, daum.net, hanmail.net, 직접 입력)
- "직접 입력" 선택 시 도메인 입력 필드 표시
- 실시간 형식 검증 피드백
- "중복확인 및 인증번호 발송" 버튼 클릭 → **REST API**
  ```
  POST /api/email/send-code
  Request: { "email": "dae_lee@example.com" }
  Response: { "success": true, "message": "인증 코드를 발송했습니다." }
  ```
  - 사용 가능: "사용 가능한 이메일입니다." + 인증번호 입력 필드 표시

#### 4.2.4 이메일 인증
- 인증번호 입력 필드 (6자리)
- 인증번호 유효기간 타이머 (예: 05:00)
- "인증하기" 버튼 (6자리 입력 시 활성화) → **REST API**
  ```
  POST /api/email/verify
  Request: { "email": "dae_lee@example.com", "code": "123456" }
  Response: { "success": true, "message": "인증 완료" }
  ```
  - 인증 성공: "인증 완료!" 메시지 + 필드 비활성화
  - 인증 실패: "인증 코드가 올바르지 않습니다." 메시지
- "인증번호 재발송" 버튼 (60초 후 활성화)

#### 4.2.5 비밀번호 입력
- 비밀번호 입력 필드 (영문, 숫자, 특수문자 8-20자)
- 실시간 형식 검증 및 피드백
  - 조건 미충족: "비밀번호에 영문, 숫자, 특수문자가 필요합니다."
  - 사용 가능: "사용 가능한 비밀번호입니다."
- 비밀번호 확인 필드
- 실시간 일치 여부 검증
  - 불일치: "비밀번호가 일치하지 않습니다." (빨간색)
  - 일치: "비밀번호가 일치합니다." (초록색)

#### 4.2.6 약관 동의
- "전체 동의" 체크박스 (모든 필수 약관 선택/해제)
- [필수] 서비스 이용약관 동의 + "약관 보기" (모달)
- [필수] 개인정보 수집 및 이용 동의 + "약관 보기" (모달)
- [필수] 민감정보 수집 및 이용 동의 + "약관 보기" (모달)
- 모든 필수 약관 동의 시 "정보 입력 완료" 버튼 활성화

#### 4.2.7 정보 입력 완료
- "정보 입력 완료" 버튼 클릭 → **REST API**
  ```
  POST /api/register/step1/
  Request: { "login_id": "dae_lee", "password": "hashed_password", "email": "dae_lee@example.com", "nickname": "대연" }
  Response: { "success": true, "data": { "uuid": "550e8400-e29b-41d4-a716-446655440000", "message": "기본 정보 등록 완료" } }
  ```
- 입력된 정보 유효성 검증
- 서버가 임시 UUID를 생성하고 Redis 캐시에 임시 저장 (TTL: 30분)
- 유효하면 사용자 등록 화면으로 이동

---

### 4.3 Step 2: 기기 연결

**실행 흐름:**
1. 기기 연결 화면으로 이동
2. 프리셋 별칭 입력 필드 (예: 거실, 멀티룸) 기본값: 프리셋 {가장 작은 사용하지 않는 번호}
3. 기기 연결 안내: "SARVIS 기기와 유선 케이블로 연결해주세요."
4. 기기 연결 가이드 이미지/비디오 표시
5. "기기 연결 대기중..." 상태 표시
6. 기기 연결 감지 완료 시 "기기가 연결되었습니다!" 메시지
7. 프리셋 별칭 입력 + 기기 감지 완료 시 "사용자 등록하기" 버튼 활성화

**기기 연결 대기중... 30초 대기 후 "기기 연결 재시도"버튼 노출**

---

### 4.4 Step 3: 사용자 등록 (얼굴)

**실행 흐름:**
1. 사용자 등록 화면으로 이동
2. "기기에 사용자 정보 전송 중..." 메시지
3. 카메라 자동 활성화 및 얼굴 스캔 시작
4. 안내 메시지: "얼굴을 중앙에 맞춰주세요", "인식 중입니다..."
5. 10초 내 얼굴 이미지 캡처
6. **Jetson 로컬 통신:** 얼굴 이미지 Jetson 전송
   ```
   POST http://192.168.x.x:8000/register/upload
   FormData: { face_image: File }
   Response: { "success": true, "face_vector": [0.123, -0.456, ...] }
   ```
7. Jetson에서 로컬 임베딩 연산 (얼굴 벡터 추출, 512-dim)
8. **REST API:** 벡터 데이터 서버 전송
   ```
   POST /api/register/face-vector
   Request: { "uuid": "550e8400-e29b-41d4-a716-446655440000", "face_vector": [0.123, -0.456, ...] }
   Response: { "success": true, "data": { "message": "얼굴 벡터화 완료" } }
   ```
9. 서버에서 벡터 데이터를 Redis 캐시에 임시 저장 (Key: signup:temp:{uuid}, field: face_vector)
10. "사용자 등록 완료!" 메시지
11. 1초 후 음성 등록 화면으로 이동

**사용자 등록 실패:**
- 10초간 얼굴 인식 실패 시 에러 메시지
  - "얼굴이 너무 어둡습니다"
  - "여러 얼굴이 감지되었습니다"
  - "얼굴이 화면 중앙에 오지 않았습니다"
- 재시도 버튼 표시

---

### 4.5 Step 4: 음성 등록

**실행 흐름:**
1. 음성 등록 화면으로 이동
2. "음성 등록 시작" 버튼 클릭
3. 음성 등록 문장 예시 표시: "SARVIS를 불러보세요"
4. "녹음 중..." 메시지 + 실시간 파형 애니메이션
5. 인식 완료 시 "인식 성공!" 후 필요할 때까지 반복
6. 음성 벡터 수집 진행률 표시 (예: 33% → 66% → 100%)
7. 충분한 음성 원본 오디오 수집 완료
8. **Jetson 로컬 통신:** 음성 오디오 Jetson 전송
   ```
   POST http://192.168.x.x:8000/register/upload
   FormData: { voice_audio: File }
   Response: { "success": true, "voice_vector": [0.123, -0.456, ...] }
   ```
9. Jetson에서 로컬 임베딩 연산 (음성 벡터 추출, 256-dim)
10. **REST API:** 벡터 데이터 서버 전송
    ```
    POST /api/register/voice-vector
    Request: { "uuid": "550e8400-e29b-41d4-a716-446655440000", "voice_vector": [0.123, -0.456, ...] }
    Response: { "success": true, "data": { "message": "음성 벡터화 완료" } }
    ```
11. 서버에서 벡터 데이터를 Redis 캐시에 임시 저장 (Key: signup:temp:{uuid}, field: voice_vector)
12. "음성 등록 완료!" 메시지
13. 1초 후 **REST API:** 회원가입 완료
    ```
    POST /api/register/complete/
    Request: { "uuid": "550e8400-e29b-41d4-a716-446655440000" }
    Response: { "success": true, "data": { "user_id": 1, "token": "...", "user": {...}, "session_id": 1 } }
    ```
14. 서버에서 Redis 캐시에서 임시 데이터 조회 후 User, UserDeviceConnection, Session 생성
15. 캐시 삭제
16. 앱에 JWT 토큰 전송
17. 홈 화면으로 이동

**음성 인식 실패:**
- 3초 안에 "SARVIS"를 인식하지 못했을 시 인식 실패
- "인식 실패!" 후 필요할 때까지 "녹음 중..." 반복

**음성 등록 취소:**
- "등록 취소" 버튼 클릭
- "음성 등록을 취소하시겠습니까?" 확인 팝업
- 확인 시 이전 단계로 복귀

**음성 등록 건너뛰기:**
- "건너뛰기" 버튼 클릭
- "음성 명령 기능을 사용할 수 없습니다. 나중에 설정에서 등록할 수 있습니다." 안내
- 확인 시 바로 홈 화면으로 이동
- 음성 벡터는 null로 서버에 저장

---

## 5. 메인 화면

### 5.1 화면 구조

**상단:**
- 사용자 이름 뱃지
- 기기 연결 상태 인디케이터 (항상 표시)
- 메뉴 버튼 (점 세개)

**하단 탭:**
- 홈 (기본)
- 제어

---

### 5.2 홈 탭 - 음성 명령 제어

**음성 명령 활성화:**
- 기본 활성화 상태
- 상태: "듣고 있습니다..."
- 실시간 인식된 텍스트 표시
- 음성 파형 애니메이션 재생

**음성 명령 비활성화:**
- 음성 벡터 null로 저장되어 있을 때 마이크 off
- 상태: "음성 정보를 등록해 주세요."
- 음성 파형 애니메이션 정지

**음성 명령 실행 (SARVIS, {명령}):**
1. 사용자가 명령어 발음
2. Jetson 마이크에서 음성 인식 및 텍스트 변환
3. 명령 파싱
4. **REST API:** 로봇 제어 명령 전송
   ```
   POST /api/robot/command
   Request: { "session_id": 1, "command": "follow" }
   Response: { "success": true, "message": "명령 전송 완료" }
   ```
5. Jetson에서 RPi로 제어 신호 전송 (내부 유선 연결)
6. RPi에서 모터 제어
7. 명령 완료 후 Jetson에서 **REST API:** 로봇 상태 업데이트
   ```
   PUT /api/sessions/{session_id}/robot-status
   Request: { "robot_status": "TRACKING", "last_voice_command": "따라와" }
   Response: { "success": true, "data": { "session_id": 1, "robot_status": "TRACKING" } }
   ```
8. 실시간 인식된 텍스트 초기화
9. 5초 동안 음성 인식이 없을 경우 자동으로 타임아웃 처리 후 "듣고 있습니다..." 상태로 복귀

**음성 명령 예시:**
- "따라와": 로봇 상태 "추적 중" (녹색)
- "내 앞으로": 로봇 상태 "이동 중" (파란색) → 완료 후 "대기 중" (회색)
- "멈춰": 로봇 즉시 정지 → "대기 중" (회색)
- "저리 가": 로봇 상태 "시야 밖으로 이동 중" (주황색) → 완료 후 "대기 중" (회색)
- "왼쪽으로": 로봇 상태 "이동 중" (파란색)(left로 1 step만큼 이동) → 완료 후 "대기 중" (회색)

**음성 인식 실패:**
- "다시 말씀해주세요" 메시지
- 0.5초 후 "듣고 있습니다..."로 복귀

**음성 인식 타임아웃:**
- 5초 동안 음성 입력이 없을 경우 자동 타임아웃
- 실시간 인식 텍스트 초기화
- "듣고 있습니다..." 상태로 복귀

---

### 5.3 홈 탭 - 핸드프리 유튜브 제어

**핸드프리 모드 활성화:**
- "핸드프리 제어" 토글 버튼

**핸드프리 제어 활성화:**
1. 사용자가 핸드프리 제어 토글 버튼을 ON으로 설정
2. 앱이 접근성 서비스 권한 상태 확인
3. **권한 허용 상태:**
   - Foreground Service 시작
4. **권한 미승인 상태:**
   - "접근성 권한이 필요합니다." 안내 팝업
   - "설정하러 가기"/취소 버튼 노출
   - 토글 OFF로 변경

**핸드프리 모드 제어 명령 (음성):**

- **유튜브 뒤로 감기:**
  - Jetson: 음성 "유튜브 뒤로" 인식
  - **REST API:** 로봇 제어 명령 전송
    ```
    POST /api/robot/command
    Request: { "session_id": 1, "command": "youtube_control", "action": "rewind", "value": 10 }
    Response: { "success": true, "message": "명령 전송 완료" }
    ```
  - Android Native: Accessibility Service로 좌측 더블 탭 제스처 시뮬레이션
  - 유튜브: 10초 뒤로 감기

- **유튜브 앞으로 감기:**
  - Jetson: 음성 "유튜브 앞으로" 인식
  - **REST API:** 로봇 제어 명령 전송
  - Android Native: Accessibility Service로 우측 더블 탭 제스처 시뮬레이션
  - 유튜브: 10초 앞으로 감기

- **유튜브 정지/재생:**
  - Jetson: 음성 "유튜브 정지" 또는 "유튜브 재생" 인식
  - **REST API:** 로봇 제어 명령 전송
  - Android Native: Accessibility Service로 중앙 탭 제스처 시뮬레이션
  - 유튜브: 정지/재생 토글

- **유튜브 볼륨 올려:**
  - Jetson: 음성 "유튜브 볼륨 올려" 인식
  - **REST API:** 로봇 제어 명령 전송
  - Android Native: 볼륨 업 제스처 시뮬레이션
  - 유튜브: 볼륨 +1

- **유튜브 볼륨 내려:**
  - Jetson: 음성 "유튜브 볼륨 내려" 인식
  - **REST API:** 로봇 제어 명령 전송
  - Android Native: 볼륨 다운 제스처 시뮬레이션
  - 유튜브: 볼륨 -1

**세션 및 보안 제한:**
- **활성 연결 모드** (기기 연결 중): 핸드프리 제어 기능 작동
- **60분 유예 세션** (기기 연결 끊김 후 60분 내): 핸드프리 제어 기능 작동
- **세션 만료** (60분 경과 또는 JWT 만료): 핸드프리 제어 기능 차단
  - "세션이 만료되었습니다. 다시 로그인해주세요." 안내
  - 모든 제어 로직 차단
  - 로그인 화면으로 유도

**백그라운드 유지:**
- Android Native Foreground Service 실행
- 기기(RPi/Jetson)와 유선 연결 유지
- 음성 명령 대기 상태 유지

---

### 5.4 홈 탭 - 빠른 제어 (로봇 제어, 음성 명령으로 아래 기능 매핑)

**따라와 토글:**
1. 토글 on
2. **REST API:** 로봇 제어 명령 전송
   ```
   POST /api/robot/command
   Request: { "session_id": 1, "command": "follow" }
   Response: { "success": true, "message": "명령 전송 완료" }
   ```
3. 로봇 상태 "추적 중" (녹색)
4. 토글 off시 "대기 중" (회색)

**시야 밖으로 버튼:**
1. 버튼 클릭
2. **REST API:** 로봇 제어 명령 전송
3. 로봇 상태 "시야 밖으로 이동 중" (주황색)
4. 텍스트 "시야 밖으로 이동 중..."
5. 완료 후 "대기 중" (회색)
6. 텍스트 "시야 밖으로 이동 완료"

**이리 와 버튼:**
1. 버튼 클릭
2. **REST API:** 로봇 제어 명령 전송
3. 로봇 상태 "이동 중" (파란색)
4. 텍스트 "사용자에게 이동 중..."
5. 완료 후 "대기 중" (회색)
6. 텍스트 "이동 완료"

---

### 5.5 제어 탭 - 수동 제어 (음성 명령으로 아래 제어 기능 매핑)

**제어 패널 구성:**
- 상태 표시(클릭 시 모달): 좌(우) 3, 위(아래) 3, 왼쪽(오른쪽) 각도 0°, 위쪽 각도(아래쪽) 0°, 거리: 3단계
- 위치 이동: 상, 하, 좌, 우 버튼
- 거리 조절: 5단계 스텝형 눈금 슬라이더: 가까이 ←→ 멀리
- 회전 제어: 좌/우, 상/하 버튼
- 기능 버튼: 프리셋 저장, 되돌리기

**위치 이동 (상/하/좌/우):**
- "위쪽 화살표"버튼 클릭: **REST API** 로봇 제어 명령 전송
  ```
  POST /api/robot/command
  Request: { "session_id": 1, "command": "move_up", "value": 1 }
  Response: { "success": true, "message": "명령 전송 완료" }
  ```
  로봇 상 방향 1 step 이동, Y -1 (사용자 표기 x)
- "아래쪽 화살표"버튼 클릭: Y +1 (사용자 표기 x)
- "왼쪽 화살표"버튼 클릭: X -1 (사용자 표기 x)
- "오른쪽 화살표"버튼 클릭: X +1 (사용자 표기 x)

**거리 조절:**
- 스텝형 슬라이더 드래그
- 범위: 가까이 ←→ 멀리
- Z 값 변경 (0, 25, 50, 75, 100) (사용자 표기 x)

**회전 제어 (Tilt/HAS):**
- "상하제어 ⍐⍗":
  1. ⍐: **REST API** 로봇 제어 명령 전송
     ```
     POST /api/robot/command
     Request: { "session_id": 1, "command": "tilt_up", "value": 3 }
     Response: { "success": true, "message": "명령 전송 완료" }
     ```
     상 방향 3° 회전, Tilt -3° (사용자 표기 x)
  2. ⍗: 하 방향 3° 회전, Tilt +3° (사용자 표기 x)
- "좌우제어 ⍐⍗":
  1. ⍇: **REST API** 로봇 제어 명령 전송
     ```
     POST /api/robot/command
     Request: { "session_id": 1, "command": "turn_left", "value": 3 }
     Response: { "success": true, "message": "명령 전송 완료" }
     ```
     좌 방향 3° 회전, HAS -3° (사용자 표기 x)
  2. ⍈: 우 방향 3° 회전, HAS +3° (사용자 표기 x)

**프리셋 저장: (음성 명령으로 사용 불가)**
1. 원하는 위치로 수동 제어
2. "프리셋 저장" 버튼 클릭
3. **REST API:** 프리셋 저장
   ```
   PUT /api/user-manual-presets/{user_id}
   Request: { "preset_name": "내 프리셋 1", "x": 3, "y": 3, "z": 50, "tilt": 0, "has": 0 }
   Response: { "success": true, "message": "프리셋 저장 완료" }
   ```
4. 프리셋 이름 설정 필드 팝업(기본값: 프리셋 {가장 작은 사용하지 않는 번호})
5. 이름 설정 후 프리셋 저장 활성화
6. "현재 설정이 저장되었습니다.\n좌(우) 3, 위(아래) 3, 왼쪽(오른쪽) 각도 0°, 위쪽 각도(아래쪽) 0°, 거리: 3단계" 알림

**프리셋 복구: (음성 명령으로 사용 불가)**
1. 기존 프리셋에서 변경 사항 있을 시 "프리셋 복구" 버튼 활성화
2. "프리셋 복구" 버튼 클릭
3. "기존 프리셋으로 복구하시겠습니까?" 확인 팝업
4. 확인 시 사용중이던 프리셋으로 복구 (취소 시 팝업만 종료)
5. **REST API:** 프리셋 로드
   ```
   POST /api/preset/load
   Request: { "preset_id": 1 }
   Response: { "success": true, "data": { "preset_id": 1, "preset_name": "내 프리셋 1", "x": 3, "y": 3, "z": 50, "tilt": 0, "has": 0 } }
   ```
6. 모든 값이 프리셋 값으로 변경
7. **REST API:** 로봇 제어 명령 전송
8. "프리셋으로 복구되었습니다.\n좌(우) 3, 위(아래) 3, 왼쪽(오른쪽) 각도 0°, 위쪽 각도(아래쪽) 0°, 거리: 3단계" 알림

---

### 5.6 기기 연결 상태 인디케이터

**항상 상단에 표시:**
- 연결됨 (녹색)
- 연결 안됨 (빨간색)
  1. 연결 끊김 시 "기기가 연결되지 않았습니다. 기기를 연결해주세요." 메시지
  2. 인디케이터를 제외한 메인 화면 전체에 반투명 오버레이(Opacity 0.5) 적용 및 컴포넌트 터치 이벤트 비활성화

---

## 6. 메뉴

### 6.1 메뉴 열기

**실행 흐름:**
1. 상단 메뉴 버튼 (점 세개) 클릭
2. 메뉴 오버레이 표시
3. 메뉴 항목:
   - 얼굴 재설정
   - 음성 재설정
   - 기기 정보
   - 로그아웃
   - 회원 탈퇴

---

### 6.2 얼굴 재설정

**실행 흐름:**
1. 메뉴에서 "얼굴 정보 재설정" 선택
2. 얼굴 재설정 화면으로 이동
3. 기기에 얼굴 재등록 요청 (회원가입시 절차와 동일)
4. 얼굴 스캔 시작
5. 얼굴 이미지 캡처
6. **Jetson 로컬 통신:** 얼굴 이미지 Jetson 전송
   ```
   POST http://192.168.x.x:8000/biometric/face-update
   FormData: { face_image: File }
   Response: { "success": true, "message": "얼굴 재설정 완료" }
   ```
7. Jetson에서 로컬 임베딩 연산 (얼굴 벡터 추출, 512-dim)
8. **REST API:** 벡터 데이터 서버 전송
   ```
   PUT /api/users/{user_id}/face
   Request: { "face_vector": [0.123, -0.456, ...] }
   Response: { "success": true, "message": "얼굴 재설정 완료" }
   ```
9. 기존 face_vector 백업 후 BiometricLog에 변경 이력 저장
10. "사용자 얼굴 정보를 덮어씌우겠습니까?" 등록 / 취소 선택
11. 등록 시 "사용자 얼굴 정보 재설정 완료!" 메시지
12. 홈 화면으로 복귀

**취소:**
- "취소" 버튼 클릭
- "얼굴 재설정을 취소하시겠습니까?" 확인 팝업
- 확인 시 홈 화면으로 복귀 (재설정 전 기존 정보 유지)

---

### 6.3 음성 재설정

**실행 흐름:**
1. 메뉴에서 "음성 재설정" 선택
2. 음성 재설정 화면으로 이동
3. "음성 재등록 시작" 버튼 클릭
4. 음성 등록 문장 예시 표시: "SARVIS를 불러보세요"
5. "녹음 중..." 메시지 + 실시간 파형 애니메이션
6. 인식 완료 시 "인식 성공!" 후 필요할 때까지 반복
7. 음성 벡터 수집 진행률 표시 (예: 33% → 66% → 100%)
8. 충분한 음성 원본 오디오 수집 완료
9. **Jetson 로컬 통신:** 음성 오디오 Jetson 전송
   ```
   POST http://192.168.x.x:8000/biometric/voice-update
   FormData: { voice_audio: File }
   Response: { "success": true, "message": "음성 재설정 완료" }
   ```
10. Jetson에서 로컬 임베딩 연산 (음성 벡터 추출, 256-dim)
11. **REST API:** 벡터 데이터 서버 전송
    ```
    PUT /api/users/{user_id}/voice
    Request: { "voice_vector": [0.123, -0.456, ...] }
    Response: { "success": true, "message": "음성 재설정 완료" }
    ```
12. 기존 voice_vector 백업 후 BiometricLog에 변경 이력 저장
13. "음성 정보 인식 완료!" 메시지
14. "음성 정보를 덮어씌우겠습니까?" 등록 / 취소 선택
15. 등록 시 "음성 재설정 완료!" 메시지
16. 홈 화면으로 복귀

**음성 인식 실패:**
- 3초 안에 "SARVIS"를 인식하지 못했을 시 인식 실패
- "인식 실패!" 후 필요할 때까지 "녹음 중..." 반복

**취소:**
- "취소" 버튼 클릭
- "음성 재설정을 취소하시겠습니까?" 확인 팝업
- 확인 시 홈 화면으로 복귀 (재설정 전 기존 정보 유지)

---

### 6.4 기기 정보

**실행 흐름:**
1. 메뉴에서 "기기 정보" 선택
2. 기기 정보 화면으로 이동
3. **REST API:** 기기 정보 조회
   ```
   GET /api/devices/current
   Headers: Authorization: Bearer {jwt_token}
   Response: { "success": true, "data": { "device_type": "SARVIS-Pro", "serial_number": "SN-00123456789", "firmware_version": "1.0.0", "app_version": "1.0.0", "latest_firmware_version": "1.0.0" } }
   ```
4. 기기 정보 표시:
   - 기기 타입 (SARVIS-Pro)
   - Serial Number (SN-00123456789)
   - 펌웨어 버전 (1.0.0)
   - 앱 버전 (1.0.0)
5. 펌웨어 업데이트 알림 (새 버전 있을 때)
6. 뒤로가기 버튼 클릭 시 홈 화면으로 복귀

---

### 6.5 로그아웃

**실행 흐름:**
1. 메뉴에서 "로그아웃" 선택
2. "로그아웃하시겠습니까?" 확인 팝업
3. 확인 시 로그아웃 진행
4. **REST API:** 로그아웃 요청
   ```
   POST /api/auth/logout
   Request: {}
   Response: { "success": true, "message": "로그아웃 완료" }
   ```
5. 세션 종료, JWT 토큰 삭제
6. 기기와 휴대폰의 연결관계 유지 (공용 휴대폰 상황 대응)
7. 로그인 초기 화면으로 이동

---

### 6.6 회원 탈퇴

**실행 흐름:**
1. 메뉴에서 "회원 탈퇴" 선택
2. "회원 탈퇴 사유를 입력해주세요." 프롬프트
3. 사용자가 탈퇴 사유 드롭다운 선택 or 직접입력
4. 취소 버튼 클릭 시 홈 화면으로 복귀
5. 확인 시 "정말로 회원 탈퇴를 진행하시겠습니까?\n\n탈퇴 사유: [입력한 사유]\n\n이 작업은 되돌릴 수 없습니다." 확인 팝업
6. 확인 시 **REST API:** 회원 탈퇴 요청
   ```
   DELETE /api/users/{user_id}
   Request: { "withdrawal_reason": "서비스 불만족" }
   Response: { "success": true, "message": "회원 탈퇴 완료" }
   ```
7. User 삭제, BiometricLog 보존, UserDeviceConnection 삭제, Session 삭제
8. "회원 탈퇴가 완료되었습니다.\n그동안 이용해 주셔서 감사합니다." 알림
9. 로그아웃 후 로그인 초기 화면으로 이동

---

## 7. 에러 및 예외 처리

### 7.1 얼굴 인식 에러

**얼굴 스캔 중 인식 실패:**
- 에러 메시지: "얼굴을 인식할 수 없습니다."
- 원인 안내:
  - 조명이 너무 어둡습니다
  - 얼굴이 화면 중앙에 오지 않았습니다
  - 마스크를 착용했습니다
- 재시도 버튼 표시

---

### 7.2 입력 유효성 에러

**아이디 중복:**
- "이미 사용 중인 아이디입니다." (빨간색)
- 아이디 입력 필드에 포커스

**비밀번호 불일치:**
- "비밀번호가 일치하지 않습니다." (빨간색)
- 비밀번호 확인 필드에 포커스

**필수 정보 미입력:**
- "닉네임, 아이디, 비밀번호, 이메일을 모두 입력해주세요."
- 버튼 비활성화 상태 유지

**이메일 인증 실패:**
- "인증 코드가 올바르지 않습니다." (빨간색)
- 인증 코드 입력 필드에 포커스

---

### 7.3 기기 연결 에러

**연결 실패:**
- "기기 연결 대기중..." 상태 유지
- 30초 타임아웃
- "기기 연결 실패\n기기가 연결되지 않았습니다. 케이블을 확인하고 다시 시도해주세요." 메시지
- "다시 시도", "로그인 화면으로 돌아가기" 버튼

---

### 7.4 네트워크 에러

**API 요청 중 네트워크 에러:**
- "네트워크 연결을 확인해주세요." 메시지
- "다시 시도" 버튼

---

### 7.5 서버 에러

**API 요청 중 서버 에러 (HTTP 500):**
- "서버 오류가 발생했습니다.\n잠시 후 다시 시도해주세요." 메시지
- "다시 시도" 버튼

---

### 7.6 음성 인식 타임아웃

**음성 명령 대기 중 음성 입력 없음:**
- 5초 동안 음성 입력이 없을 경우 자동 타임아웃 처리
- "듣고 있습니다..." 상태로 복귀
- 실시간 인식 텍스트 초기화

---

## 8. 와이어프레임

### 8.1 앱-서버-기기 통신 와이어프레임

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           앱 (Android)                               │
│                                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │
│  │   로그인    │  │  회원가입   │  │   메인     │                  │
│  │   세션     │  │            │  │   제어     │                  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                  │
│         │                │                │                            │
│         │ REST API      │ REST API      │ REST API                  │
│         │ (HTTPS)       │ (HTTPS)       │ (HTTPS)                   │
└─────────┼────────────────┼────────────────┼────────────────────────────┘
          │                │                │
          ↓                ↓                ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                        서버 (EC2)                                     │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                    REST API Layer                               │  │
│  │  - /api/auth/* (인증)                                        │  │
│  │  - /api/register/* (회원가입)                                   │  │
│  │  - /api/devices/* (기기 관리)                                  │  │
│  │  - /api/sessions/* (세션 관리)                                 │  │
│  │  - /api/robot/* (로봇 제어)                                   │  │
│  │  - /api/preset/* (프리셋)                                     │  │
│  │  - /api/users/* (사용자 관리)                                  │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│         │                                                              │
│         │ WebSocket (WSS) - 하트비트만                                │
│         ↓                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                  WebSocket Handler                                 │  │
│  │  - Jetson 하트비트 수신 (10초 간격)                          │  │
│  │  - Connection 상태 업데이트                                   │  │
│  │  - 기기 온라인/오프라인 알림                                  │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│         │                                                              │
│         ↓                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                    Database                                     │  │
│  │  - User, Device, Session                                      │  │
│  │  - UserDeviceConnection, UserManualPreset                         │  │
│  │  - BiometricLog                                               │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────┼───────────────────────────────────────────────────────────────────┘
          │
          │ WebSocket (WSS) - 하트비트만
          │ - 10초 간격 하트비트 전송
          ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Jetson                                     │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                 WebSocket Client (하트비트)                       │  │
│  │  - 서버로 하트비트 전송 (10초 간격)                          │  │
│  │  - 서버로부터 heartbeat_ack 수신                               │  │
│  │  - Wi-Fi 신호 강도 전송                                      │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│         │                                                              │
│         │ 내부 통신 (유선)                                             │
│         ↓                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                    RPi (로봇 제어)                              │  │
│  │  - 모터 제어                                                     │  │
│  │  - 위치/회전 제어                                                │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│         │                                                              │
│         │ HTTP Server (로컬)                                          │
│         ↓                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                HTTP Handler (로컬 벡터화)                        │  │
│  │  - /register/upload (회원가입 벡터화)                            │  │
│  │  - /auth/face-verify (로그인 벡터화)                            │  │
│  │  - /biometric/face-update (얼굴 재설정)                         │  │
│  │  - /biometric/voice-update (음성 재설정)                        │  │
│  │  - 로컬 임베딩 연산: 얼굴(512-dim), 음성(256-dim)              │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────┼───────────────────────────────────────────────────────────────────┘
          │
          │ Jetson HTTP (로컬)
          │ - 얼굴/음성 원본 파일 전송
          │ - 벡터 데이터 수신
          ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                        앱 (Android) - 로컬 통신                    │
│                                                                     │
│  - Jetson으로 얼굴/음성 원본 파일 전송                               │
│  - Jetson으로부터 벡터 데이터 수신                                    │
│  - 서버로 벡터 데이터 전송 (REST API)                                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 하트비트 통신 와이어프레임

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Jetson                                     │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                 WebSocket Client                                   │  │
│  │                                                                │  │
│  │  [10초 간격 반복]                                            │  │
│  │     ↓                                                          │  │
│  │  서버로 하트비트 전송                                         │  │
│  │     {                                                           │  │
│  │       "type": "heartbeat",                                       │  │
│  │       "device_id": "JETSON-001",                                 │  │
│  │       "timestamp": 1640739900,                                  │  │
│  │       "wifi_signal": 85,                                         │  │
│  │       "connection_status": "connected"                              │  │
│  │     }                                                           │  │
│  │                                                                │  │
│  │  [서버로부터 응답 수신]                                        │  │
│  │     ↓                                                          │  │
│  │  {                                                           │  │
│  │       "type": "heartbeat_ack",                                    │  │
│  │       "device_id": "JETSON-001",                                 │  │
│  │       "timestamp": 1640739900                                   │  │
│  │     }                                                           │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│         │                                                              │
│         ↓ WebSocket (WSS)                                             │
└─────────┼───────────────────────────────────────────────────────────────────┘
          │
          │ WebSocket (WSS) - 하트비트만
          ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                        서버 (EC2)                                     │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                  WebSocket Handler                                 │  │
│  │                                                                │  │
│  │  [Jetson으로부터 하트비트 수신]                                  │  │
│  │     ↓                                                          │  │
│  │  Database에 기기 상태 저장                                       │  │
│  │     - wifi_signal: 85                                           │  │
│  │     - last_heartbeat: 1640739900                                  │  │
│  │     - connection_status: "connected"                                │  │
│  │                                                                │  │
│  │  [Jetson으로 응답 전송]                                       │  │
│  │     ↓                                                          │  │
│  │  heartbeat_ack 전송                                             │  │
│  │                                                                │  │
│  │  [앱으로 상태 변경 알림]                                         │  │
│  │     ↓                                                          │  │
│  │  {                                                           │  │
│  │       "type": "device_online" / "device_offline",                │  │
│  │       "device_id": "JETSON-001",                                 │  │
│  │       "timestamp": 1640739900                                   │  │
│  │     }                                                           │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────┼───────────────────────────────────────────────────────────────────┘
          │
          ↓ WebSocket (앱 연결)
┌─────────────────────────────────────────────────────────────────────────────┐
│                        앱 (Android)                                   │
│                                                                     │
│  - 상태 변경 알림 수신                                               │
│  - 기기 연결 상태 인디케이터 업데이트                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.3 얼굴 인식 로그인 와이어프레임

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        앱 (Android) - 로그인 화면                      │
│                                                                     │
│  - 카메라 활성화                                                    │
│  - 얼굴 스캔 (3초)                                                │
│  - 얼굴 이미지 캡처                                                │
│         │                                                              │
│         │ Jetson HTTP (로컬)                                          │
│         ↓                                                              │
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Jetson                                     │
│                                                                     │
│  - 얼굴 이미지 수신 (FormData)                                        │
│  - 로컬 임베딩 연산 (얼굴 벡터 추출, 512-dim)                        │
│         │                                                              │
│         │ REST API (HTTPS)                                            │
│         ↓                                                              │
└─────────┼───────────────────────────────────────────────────────────────────┘
          │
          ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                        서버 (EC2)                                     │
│                                                                     │
│  - 벡터 데이터 수신                                                   │
│  - 코사인 유사도 계산 (threshold: 0.48)                            │
│  - User.face_vector와 매칭                                         │
│  - JWT 토큰 생성                                                    │
│  - Session 생성                                                       │
│         │                                                              │
│         │ REST API Response (HTTPS)                                      │
│         ↓                                                              │
└─────────┼───────────────────────────────────────────────────────────────────┘
          │
          ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                        앱 (Android)                                   │
│                                                                     │
│  - 응답 수신: { "success": true, "data": { "user_id": 1, "token": "...", "user": {...}, "session_id": 1 } }  │
│  - JWT 토큰 저장                                                   │
│  - "사용자 인식 완료!" 메시지 표시                                   │
│  - 메인 화면(홈 탭)으로 이동                                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.4 로봇 제어 명령 와이어프레임

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        앱 (Android) - 홈/제어 탭                      │
│                                                                     │
│  - 사용자 버튼 클릭 (음성 명령 인식 또는 수동 제어)                       │
│  - 명령 결정 (예: "따라와", "이리 와")                                │
│         │                                                              │
│         │ REST API (HTTPS)                                            │
│         ↓                                                              │
┌─────────────────────────────────────────────────────────────────────────────┐
│                        서버 (EC2)                                     │
│                                                                     │
│  - 명령 수신                                                         │
│  - Session.robot_status 업데이트 (예: "TRACKING", "MOVING")               │
│  - 로봇 제어 신호 생성 (내부 처리)                                   │
│         │                                                              │
│         │ WebSocket (WSS) - Jetson과 직접 연결 없음                     │
│         ↓                                                              │
└─────────┼───────────────────────────────────────────────────────────────────┘
          │
          │ 내부 통신 (유선 - RPi) [서버 직접 연결]
          ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Jetson                                     │
│                                                                     │
│  - 서버로부터 로봇 제어 명령 수신                                      │
│  - RPi로 제어 신호 전송                                              │
│         │                                                              │
│         ↓                                                              │
┌─────────────────────────────────────────────────────────────────────────────┐
│                    RPi (로봇 제어)                                  │
│                                                                     │
│  - 모터 제어 실행                                                     │
│  - 완료 신호 Jetson 전송                                           │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Jetson                                     │
│                                                                     │
│  - 완료 신호 수신                                                    │
│  - REST API (HTTPS)                                               │
│         ↓                                                              │
└─────────┼───────────────────────────────────────────────────────────────────┘
          │
          ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                        서버 (EC2)                                     │
│                                                                     │
│  - 완료 신호 수신                                                     │
│  - Session.robot_status 업데이트 (예: "IDLE")                          │
│  - 앱으로 상태 전송                                                  │
│         │                                                              │
│         │ REST API Response (HTTPS)                                      │
│         ↓                                                              │
└─────────┼───────────────────────────────────────────────────────────────────┘
          │
          ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                        앱 (Android)                                   │
│                                                                     │
│  - 상태 업데이트 수신                                                  │
│  - 로봇 상태 UI 업데이트                                            │
│  - 텍스트 메시지 표시                                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.5 회원가입 완료 와이어프레임

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        앱 (Android) - 회원가입 화면                    │
│                                                                     │
│  - "회원가입 완료" 버튼 클릭                                         │
│  - UUID 전송                                                         │
│         │                                                              │
│         │ REST API (HTTPS)                                            │
│         ↓                                                              │
┌─────────────────────────────────────────────────────────────────────────────┐
│                        서버 (EC2)                                     │
│                                                                     │
│  - UUID 수신                                                         │
│  - Redis 캐시에서 임시 데이터 조회                                     │
│    - signup:temp:{uuid}                                              │
│    - login_id, password, email, nickname, face_vector, voice_vector        │
│  - User 생성                                                         │
│  - UserDeviceConnection 생성                                            │
│  - Session 생성                                                       │
│  - JWT 토큰 생성                                                    │
│  - 캐시 삭제                                                         │
│         │                                                              │
│         │ REST API Response (HTTPS)                                      │
│         ↓                                                              │
└─────────┼───────────────────────────────────────────────────────────────────┘
          │
          ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                        앱 (Android)                                   │
│                                                                     │
│  - 응답 수신: { "success": true, "data": { "user_id": 1, "token": "...", "user": {...}, "session_id": 1 } }  │
│  - JWT 토큰 저장                                                   │
│  - "회원가입 완료!" 메시지 표시                                    │
│  - 메인 화면(홈 탭)으로 이동                                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 부록

### 9.1 용어 정의

- **Tilt:** 상하 각도 제어
- **HAS:** Horizontal Angular System, 좌우 각도 제어
- **음성 벡터:** 음성 인식을 위한 사용자 음성 특성 데이터
- **얼굴 벡터:** 얼굴 인식을 위한 사용자 얼굴 특성 데이터
- **핸드프리 제어:** 음성 명령으로 유튜브와 같은 외부 앱을 제어하는 기능
- **접근성 서비스 (Accessibility Service):** 안드로이드 시스템에서 다른 앱을 제어할 수 있는 권한을 제공하는 서비스
- **Foreground Service:** 백그라운드에서 기기 연결 및 음성 명령 대기 상태를 유지하는 서비스
- **Heartbeat:** Jetson-서버 간 10초 간격 상태 확인 통신

### 9.2 상태 코드

| 상태 | 색상 | 의미 |
|------|------|------|
| 대기 중 | 회색 | 로봇 명령 대기 |
| 추적 중 | 녹색 | 사용자 추적 |
| 이동 중 | 파란색 | 명령에 따른 이동 |
| 시야 밖으로 이동 중 | 주황색 | 시야 밖으로 이동 |
| 연결됨 | 녹색 | 기기 연결 상태 |
| 연결 안됨 | 빨간색 | 기기 연결 안됨 |

### 9.3 기술 상세

| 항목 | 값 | 설명 |
|------|------|------|
| Heartbeat 주기 | 10초 | 서버와의 주기적인 통신 간격 (WebSocket) |
| JWT 만료 시간 | 24시간 | 기본 토큰 만료 시간 (기기 연결 중 무제한 유지) |
| 세션 유예 시간 | 60분 | 기기 연결 해제 후 임시 세션 유효 시간 |
| 음성 인식 타임아웃 | 5초 | 음성 명령 대기 시 타임아웃 |
| 기기 연결 타임아웃 | 30초 | 기기 연결 대기 시 타임아웃 |
| 얼굴 스캔 타임아웃 | 10초 | 얼굴 스캔 시 타임아웃 |
| 음성 인식 타임아웃 (회원가입) | 3초 | "SARVIS" 인식 타임아웃 |
| Redis 캐시 TTL | 30분 (1800초) | 회원가입 임시 데이터 만료 시간 |

---

**문서 버전:** 2.0  
**작성일:** 2026-01-30  
**최종 수정일:** 2026-01-30