# SARVIS 프로젝트 포팅 매뉴얼

## 개요
본 매뉴얼은 SARVIS (Smart Assistant Robot via Intelligent Vision & Speech) 프로젝트를 새로운 환경에 배포하기 위한 포팅 가이드입니다.

---

## 1. 빌드 및 배포 가이드

### 1.1 시스템 요구사항

| 구분 | 종류 | 버전/설정 값 | 비고 |
|------|------|-------------|------|
| OS | Ubuntu Linux | 20.04 LTS 이상 | Django 서버 |
| OS | NVIDIA JetPack | 4.6.x 이상 | Jetson Nano |
| OS | Raspberry Pi OS | Buster 이상 | 로봇 팔 제어 |
| Python | 3.10.x | - | Django 서버 |
| Python | 3.8.x | - | Jetson |
| Node.js | 18.x 이상 | - | React Native 앱 |
| DB | MySQL | 8.0.x | - |
| 웹서버 | Uvicorn | 0.30.0+ | Django ASGI 서버 |
| 웹서버 | Gunicorn | 21.x+ | Django WSGI 서버 |
| 캐시서버 | Redis | 5.0.1 | - |
| 메시지 브로커 | Celery | 5.3.6 | - |
| Nginx | 1.18+ | - | 리버스 프록시 (선택) |

### 1.2 프로젝트 구조

```
CLINE_space/
├── djangopjt-master/          # Django 백엔드 서버
├── SARVIS_app/sarvis/         # React Native 모바일 앱
├── Jetson/
│   ├── vision_test/           # 비전 시스템
│   └── voice_test/            # 보이스 시스템
└── JINWOO/
    └── arm/                  # 로봇 팔 제어
```

---

## 2. Django 백엔드 서버 배포

### 2.1 소스 코드 클론

```bash
# 프로젝트 디렉토리로 이동
cd /path/to/project

# Django 백엔드 디렉토리로 이동
cd djangopjt-master
```

### 2.2 의존성 설치

```bash
# 가상 환경 생성 (선택)
python3 -m venv venv
source venv/bin/activate

# 의존성 패키지 설치
pip install -r requirements.txt
```

### 2.3 환경 변수 설정

`.env` 파일 생성 (프로젝트 루트 디렉토리):

```env
# Django Secret Key
SECRET_KEY=your-django-secret-key-here
DEBUG=False

# Database Configuration
DB_NAME=sarvis_db
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_HOST=localhost
DB_PORT=3306

# Redis Configuration
REDIS_HOST=localhost
REDIS_PORT=6379

# Email Configuration (Gmail SMTP)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password
DEFAULT_FROM_EMAIL=your-email@gmail.com
```

### 2.4 데이터베이스 설정

```bash
# MySQL 데이터베이스 생성
mysql -u root -p
CREATE DATABASE sarvis_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'sarvis_user'@'localhost' IDENTIFIED BY 'djdahdkf123';
GRANT ALL PRIVILEGES ON sarvis_db.* TO 'sarvis_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# Django 마이그레이션 실행
python manage.py makemigrations
python manage.py migrate
```

### 2.5 캐시 및 메시지 브로커 설정

```bash
# Redis 설치 (Ubuntu)
sudo apt update
sudo apt install redis-server

# Redis 서비스 시작
sudo systemctl start redis
sudo systemctl enable redis

# Redis 상태 확인
redis-cli ping
# 응답: PONG
```

### 2.6 Celery Worker 설정

```bash
# Celery 백그라운드 서비스 실행
celery -A server worker -l info --logfile celery.log

# Celery Beat 스케줄러 실행 (새 터미널)
celery -A server beat -l info --logfile celery-beat.log
```

### 2.7 웹서버 실행

#### 개발 환경
```bash
python manage.py runserver 0.0.0.0:8080
```

#### 프로덕션 환경 (Gunicorn)
```bash
# Gunicorn 설치
pip install gunicorn

# Gunicorn 실행
gunicorn server.wsgi:application --bind 0.0.0.0:8080 --workers 4 --timeout 120
```

#### 프로덕션 환경 (Uvicorn - WebSocket 지원)
```bash
# Uvicorn 설치
pip install uvicorn

# Uvicorn 실행
uvicorn server.asgi:application --host 0.0.0.0 --port 8080 --workers 4
```

### 2.8 배포 시 특이사항

| 항목 | 내용 |
|------|------|
| CORS 설정 | ALLOWED_HOSTS에 모든 도메인을 허용하도록 설정되어 있음 (프로덕션에서는 제한 필요) |
| JWT 토큰 수명 | Access Token: 1시간, Refresh Token: 7일 |
| 세션 타임아웃 | 30분 (Redis 캐시) |
| 하트비트 체크 | Celery Beat로 60초마다 실행 |
| 미디어 파일 | 별도의 미디어 서버 구성 필요 |
| 정적 파일 | Nginx에서 정적 파일 서빙 권장 |
| WebSocket | Django Channels ASGI 사용 필요 |

---

## 3. Jetson Nano 배포

### 3.1 Jetson 환경 설정

```bash
# Jetson 환경 설치 스크립트 실행
cd Jetson
bash scripts/install_jetson_env.sh
```

### 3.2 Jetson Vision 시스템

```bash
cd vision_test

# 의존성 설치
pip install -r ../requirements-vision.txt

# 환경 변수 설정 (.env 파일)
DJANGO_API_URL=http://your-django-server:8080
JETSON_CAMERA_DEVICE=/dev/video0
```

#### 실행
```bash
python main.py
```

### 3.3 Jetson Voice 시스템

```bash
cd voice_test

# 의존성 설치
pip install -r ../requirements-audio.txt

# 환경 변수 설정 (.env 파일)
DJANGO_API_URL=http://your-django-server:8080
KWS_MODEL_PATH=./models/dscnn_model.onnx
STT_MODEL_PATH=./models/whisper_model
```

#### 실행
```bash
# 키워드 스포팅 및 STT 서버 실행
python main.py
```

### 3.4 Jetson 배포 시 특이사항

| 항목 | 내용 |
|------|------|
| GPU 가속 | TensorRT 및 ONNX Runtime GPU 사용 |
| 딥러닝 모델 | Jetson GPU에 최적화된 모델 필요 |
| 카메라 디바이스 | /dev/video0 기본값 (설정 가능) |
| 오디오 디바이스 | PulseAudio 또는 ALSA 사용 |
| 전력 관리 | jetson_clocks 명령어로 성능 최적화 가능 |

---

## 4. 로봇 팔 제어 (Raspberry Pi) 배포

### 4.1 하드웨어 연결

| 항목 | 설명 |
|------|------|
| I2C 버스 | I2C1 (SDA: GPIO 2, SCL: GPIO 3) |
| PCA9685 드라이버 | 주소 0x40 (기본값) |
| 서보 모터 | 5개 채널 사용 (8ch, 1ch, 2ch, 4ch, 5ch, 6ch) |
| 전원 | 5V 외부 전원 공급 권장 |

### 4.2 소프트웨어 설치

```bash
cd JINWOO/arm

# Python 의존성 설치
pip install adafruit-circuitpython-pca9685 adafruit-circuitpython-busio

# I2C 활성화
sudo raspi-config
# Interface Options -> I2C -> Enable
```

### 4.3 실행

```bash
python sixmotor.py
```

### 4.4 로봇 팔 배포 시 특이사항

| 항목 | 내용 |
|------|------|
| PWM 주파수 | 50Hz (PCA9685) |
| 각도 범위 | 0-180도 |
| 부드러운 모션 | STEP_SIZE=1.0, DELAY=0.01 설정 |
| 듀얼 드라이브 | 1ch, 2ch는 반대 방향으로 회전 |

---

## 5. React Native 앱 빌드

### 5.1 개발 환경 설정

```bash
cd SARVIS_app/sarvis

# 의존성 설치
npm install

# 환경 변수 설정 (.env 파일)
API_BASE_URL=http://http://i14a104.p.ssafy.io:8080
WS_URL=ws://http://i14a104.p.ssafy.io:8080/ws
```

### 5.2 개발 모드 실행

```bash
# Expo 개발 서버 실행
npm start

# Android 에뮬레이터
npm run android

# iOS 시뮬레이터 (macOS만)
npm run ios
```

### 5.3 프로덕션 빌드

#### Android APK 빌드
```bash
npm run android
# Expo Go 앱을 통해 테스트 후
# EAS Build로 APK 생성
eas build --platform android
```

#### iOS IPA 빌드
```bash
eas build --platform ios
```

### 5.4 앱 배포 시 특이사항

| 항목 | 내용 |
|------|------|
| 카메라 권한 | expo-camera 사용 |
| 마이크 권한 | expo-speech-recognition 사용 |
| 네트워크 권한 | API 통신을 위한 인터넷 권한 필요 |
| 알림 권한 | @notifee/react-native 사용 |

---

## 6. 외부 서비스 정보

### 6.1 데이터베이스 서비스

| 항목 | 내용 |
|------|------|
| 서비스 종류 | MySQL 8.0.x |
| 제공사 | - |
| 가입 URL | - |
| 연동 방법 | JDBC/PDO 드라이버 사용 |
| 주요 설정 | utf8mb4 문자셋, 슬로우 쿼리 로그 |

### 6.2 캐시/메시지 브로커 서비스

| 항목 | 내용 |
|------|------|
| 서비스 종류 | Redis 5.0.1 |
| 제공사 | - |
| 가입 URL | - |
| 연동 방법 | django-redis 라이브러리 사용 |
| 주요 설정 | 데이터베이스 번호 분리 (0: Celery, 1: 세션) |

### 6.3 이메일 서비스

| 항목 | 내용 |
|------|------|
| 서비스 종류 | Gmail SMTP |
| 제공사 | Google |
| 가입 URL | https://accounts.google.com |
| 연동 방법 | SMTP 호스트, 포트, 앱 비밀번호 사용 |
| 주요 설정 | STARTTLS 사용, 포트 587 |

### 6.4 클라우드 서비스

| 항목 | 내용 |
|------|------|
| 배포 환경 | i14a104.p.ssafy.io |
| 제공사 | SSAFY |
| Django Server | 8080 포트 |
| Jetson API | 70.12.245.122:5000 |

### 6.5 소셜 로그인

| 항목 | 내용 |
|------|------|
| 서비스 종류 | - |
| 제공사 | - |
| 가입 URL | - |
| 현재 상태 | 구현되지 않음 (향후 확장 가능) |

### 6.6 코드 컴파일/배포 서비스

| 항목 | 내용 |
|------|------|
| 서비스 종류 | EAS Build (Expo) |
| 제공사 | Expo |
| 가입 URL | https://expo.dev |
| 연동 방법 | Expo CLI 사용 |
| 주요 설정 | Android/iOS 빌드 자동화 |

---

## 7. 주요 계정 및 프로퍼티 파일 목록

### 7.1 Django 서버

| 파일/경로 | 설명 | 비고 |
|-----------|------|------|
| `djangopjt-master/.env` | 환경 변수 (DB, Redis, 이메일 등) | 배포 전 반드시 설정 필요 |
| `djangopjt-master/server/settings.py` | Django 설정 파일 | 환경 변수 참조 |
| `djangopjt-master/server/celery.py` | Celery 설정 | Redis 브로커 URL 설정 |

### 7.2 Jetson Vision

| 파일/경로 | 설명 | 비고 |
|-----------|------|------|
| `Jetson/vision_test/.env` | 환경 변수 (API URL, 카메라 등) | 배포 전 반드시 설정 필요 |
| `Jetson/vision_test/config.py` | 비전 시스템 설정 | 모델 경로, 임계값 등 |

### 7.3 Jetson Voice

| 파일/경로 | 설명 | 비고 |
|-----------|------|------|
| `Jetson/voice_test/.env` | 환경 변수 (API URL, 모델 등) | 배포 전 반드시 설정 필요 |
| `Jetson/voice_test/config.py` | 보이스 시스템 설정 | STT, KWS 모델 설정 |

### 7.4 React Native 앱

| 파일/경로 | 설명 | 비고 |
|-----------|------|------|
| `SARVIS_app/sarvis/.env` | 환경 변수 (API URL) | 배포 전 반드시 설정 필요 |
| `SARVIS_app/sarvis/constants/config.ts` | API 엔드포인트 설정 | 빌드 시 포함됨 |

### 7.5 접속 정보

| 항목 | 값 | 비고 |
|------|-----|------|
| Django Admin URL | http://localhost:8080/admin | 슈퍼유저 계정 필요 |
| API Swagger UI | http://localhost:8080/api/schema/swagger-ui/ | API 테스트 가능 |
| WebSocket URL | ws://localhost:8080/ws/app/{session_key}/ | 세션 키 필요 |

---

## 8. DB 덤프 파일

### 8.1 덤프 생성

```bash
# MySQL 덤프 생성
mysqldump -u root -p sarvis_db > sarvis_dump_$(date +%Y%m%d).sql
```

### 8.2 덤프 복구

```bash
# MySQL 덤프 복구
mysql -u root -p sarvis_db < sarvis_dump_YYYYMMDD.sql
```

### 8.3 덤프 파일 명명 규칙

| 파일명 | 설명 |
|--------|------|
| `sarvis_dump_20260207.sql` | 2026년 2월 7일자 덤프 파일 |
| `sarvis_dump_latest.sql` | 최신 덤프 파일 |

---

## 9. 시연 시나리오

### 9.1 시연 준비

1. Django 서버 실행
2. Jetson Vision 서버 실행
3. Jetson Voice 서버 실행
4. 로봇 팔 서버 실행
5. React Native 앱 설치 및 실행

### 9.2 시연 순서

#### 시연 1: 인식 및 추적 (2분 30초)

| 순서 | 시간 | 화면 | 실행 | 설명 |
|------|------|------|------|------|
| 1 | 00:00-01:00 | 회원가입 화면 | 이메일, 비밀번호, 사용자명 입력 후 "회원가입" 버튼 클릭 | 회원가입 요청 |
| 2 | 01:00-01:30 | 얼굴 로그인 화면 | 카메라 권한 허용 후 얼굴을 비추고 "인식" 버튼 클릭 | 얼굴 스캔 기반 로그인 |
| 3 | 01:30-02:30 | 메인 화면 | "따라와", "이리와", "저리가" 음성 명령 후 로봇 팔 동작 확인 | 얼굴 추적 및 로봇 팔 제어 시연 |

#### 시연 2: 프리셋 (1분 30초)

| 순서 | 시간 | 화면 | 실행 | 설명 |
|------|------|------|------|------|
| 1 | 00:00-00:30 | 로봇 팔 제어 화면 | 방향키(상/하/좌/우)로 미세 위치 조정 | 정밀한 로봇 팔 위치 제어 |
| 2 | 00:30-01:00 | 프리셋 생성 화면 | 현재 위치를 "저장" 버튼 클릭하여 프리셋 저장 | 프리셋 저장 |
| 3 | 01:00-01:30 | 프리셋 목록 화면 | 저장된 프리셋 선택 후 "불러오기" 버튼 클릭 | 프리셋 불러오기 |
| 4 | 01:30-02:00 | 메인 화면 | 저장한 프리셋대로 로봇 팔이 정확히 따라오는지 확인 | 프리셋 실행 검증 |
| 5 | 02:00-02:30 | 로봇 팔 제어 화면 | 앱 화면의 수동 제어 버튼으로 로봇 팔 직접 제어 | 앱 수동 제어 시연 |

#### 시연 3: 음성 명령 (1분)

| 순서 | 시간 | 화면 | 실행 | 설명 |
|------|------|------|------|------|
| 1 | 00:00-00:10 | 메인 화면 | 앱을 백그라운드로 전환 | 백그라운드에서 앱 작동 상태 확인 |
| 2 | 00:10-00:30 | 화면 상단바 | 상단바 노티피케이션 또는 상태바 아이콘 확인 | 백그라운드 작동 중 표시 |
| 3 | 00:30-01:00 | 메인 화면 (백그라운드) | "SARVIS"라고 말했을 때 반응 확인 후 "따라와", "이리와", "저리가" 음성 명령 | 백그라운드 음성 명령 시연 |

#### 시연 4: 백그라운드에서 타앱(유튜브) 제어 (1분 20초)

| 순서 | 시간 | 화면 | 실행 | 설명 |
|------|------|------|------|------|
| 1 | 00:00-00:10 | 메인 화면 | 로봇 팔을 유튜브 영상 제어 모드로 설정 | 유튜브 제어 모드 활성화 |
| 2 | 00:10-00:20 | YouTube 앱 | YouTube 앱 실행 및 영상 선택 | 영상 로드 |
| 3 | 00:20-00:30 | YouTube 앱 | 영상 재생 버튼 클릭 | 영상 재생 시작 |
| 4 | 00:30-00:40 | YouTube 앱 | "일시정지" 음성 명령 | 일시정지 동작 확인 |
| 5 | 00:40-00:50 | YouTube 앱 | "10초 전" 음성 명령 | 10초 뒤로 이동 확인 |
| 6 | 00:50-01:00 | YouTube 앱 | "10초 후" 음성 명령 | 10초 앞으로 이동 확인 |
| 7 | 01:00-01:10 | YouTube 앱 | "영상 선택" 또는 다른 영상 선택 음성 명령 | 영상 변경 확인 |
| 8 | 01:10-01:30 | 로그인 화면 | 로그아웃 버튼 클릭 및 로그아웃 확인 | 시연 종료 |

### 9.3 시연 시 주의사항

| 항목 | 내용 |
|------|------|
| 네트워크 연결 | 모든 서버가 동일한 네트워크에 있어야 함 |
| 카메라 및 마이크 권한 | 앱에서 반드시 권한 허용 필요 |
| 로봇 팔 전원 | Raspberry Pi와 로봇 팔에 전원이 연결되어야 함 |
| 순서 준수 | 얼굴 등록 후 얼굴 인증 가능, 음성 등록 후 음성 명령 가능 |
| 세션 타임아웃 | 30분 동안 활동이 없으면 자동 로그아웃됨 |

---

## 10. 문제 해결 가이드

### 10.1 Django 서버

| 문제 | 해결 방법 |
|------|----------|
| 데이터베이스 연결 실패 | `.env` 파일의 DB 설정 확인, MySQL 서버 실행 확인 |
| Redis 연결 실패 | Redis 서버 실행 (`sudo systemctl start redis`) |
| WebSocket 연결 실패 | ASGI 서버 실행 (Uvicorn 사용), 방화벽 확인 |
| Celery Worker 실행 안됨 | Redis 실행 확인, `celery -A server worker` 명령어 확인 |
| CORS 에러 | `settings.py`의 CORS_ALLOW_ALL_ORIGINS 확인 |

### 10.2 Jetson

| 문제 | 해결 방법 |
|------|----------|
| 카메라 연결 실패 | `/dev/video0` 확인, 카메라 권한 확인, 재연결 |
| GPU 메모리 부족 | 다른 프로세스 종료, Jetson 재부팅 |
| 모델 로딩 실패 | 모델 파일 경로 확인, 모델 호환성 확인 |
| 음성 인식 실패 | 마이크 볼륨 확인, VAD 임계값 조정 |

### 10.3 로봇 팔

| 문제 | 해결 방법 |
|------|----------|
| 모터 응답 없음 | I2C 연결 확인, PCA9685 주소 확인, 전원 확인 |
| 모터 떨림 | PWM 주파수 확인 (50Hz), 전원 용량 확인 |
| 각도 이상 | `angle_to_duty()` 함수 확인, 서보 모터 보정 |

### 10.4 React Native 앱

| 문제 | 해결 방법 |
|------|----------|
| API 연결 실패 | `.env` 파일의 API_BASE_URL 확인, 네트워크 연결 확인 |
| 카메라 권한 거부 | 앱 설정에서 카메라 권한 허용 |
| 마이크 권한 거부 | 앱 설정에서 마이크 권한 허용 |
| WebSocket 연결 끊김 | 네트워크 안정성 확인, 하트비트 재전송 로직 확인 |

---

## 11. 부하 테스트

### 11.1 Locust 설정

```bash
cd djangopjt-master
locust -f locustfile.py --host=http://i14a104.p.ssafy.io:8080/
```

### 11.2 테스트 시나리오

| 시나리오 | 사용자 수 | 요청 속도 |
|----------|-----------|-----------|
| 로그인 테스트 | 100 | 10 req/s |
| 얼굴 인식 테스트 | 50 | 5 req/s |
| 음성 명령 테스트 | 20 | 2 req/s |

---

## 12. 로그 및 모니터링

### 12.1 로그 파일

| 로그 | 경로 | 설명 |
|------|------|------|
| Django 로그 | 콘솔 출력 | Django 기본 로그 |
| 하트비트 로그 | `djangopjt-master/logs/heartbeat.log` | WebSocket 하트비트 메시지 |
| Celery 로그 | `celery.log` | Celery Worker 로그 |
| Celery Beat 로그 | `celery-beat.log` | Celery Beat 로그 |

### 12.2 모니터링 도구

| 도구 | 용도 |
|------|------|
| Redis CLI | `redis-cli monitor` - Redis 모니터링 |
| MySQL | `SHOW PROCESSLIST` - DB 연결 확인 |
| htop | 시스템 리소스 모니터링 |
| jetson-stats | Jetson GPU/CPU/메모리 모니터링 |

---

## 13. 보안 체크리스트

| 항목 | 확인 사항 |
|------|----------|
| Django SECRET_KEY | 프로덕션에서는 반드시 변경 |
| DB 비밀번호 | 복잡한 비밀번호 사용 |
| Redis 비밀번호 | (선택사항) Redis 암호화 활성화 |
| JWT 토큰 수명 | 적절한 수명 설정 (현재: 1시간/7일) |
| CORS 설정 | 프로덕션에서 특정 Origin만 허용 |
| HTTPS/TLS | 이메일 전송에 TLS 사용 |
| 방화벽 | 불필요한 포트 차단 |

---

## 14. 연락처 및 지원

| 항목 | 정보 |
|------|------|
| 프로젝트 이름 | SARVIS (Smart Assistant Robot via Intelligent Vision & Speech) |
| 팀 정보 | SSAFY 14기 공통 프로젝트 |
| 기술 문의 | 담당 프로 |
| 배포 문의 | 담당 프로 |

---

## 15. 부록

### A. Docker Compose 설정 (선택사항)

```yaml
version: '3.8'

services:
  django:
    build: ./djangopjt-master
    ports:
      - "8080:8080"
    environment:
      - DEBUG=False
      - DB_HOST=db
      - REDIS_HOST=redis
    depends_on:
      - db
      - redis

  db:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=sarvis_db
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:5.0
    ports:
      - "6379:6379"

  celery:
    build: ./djangopjt-master
    command: celery -A server worker -l info
    environment:
      - REDIS_HOST=redis
    depends_on:
      - redis

volumes:
  mysql_data:
```

### B. Nginx 설정 (선택사항)

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /ws/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /static/ {
        alias /path/to/djangopjt-master/static/;
    }
}
```
